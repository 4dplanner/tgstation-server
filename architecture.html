<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>tgstation-server: Server Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="tgs.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tgstation-server
   </div>
   <div id="projectbrief">The /tg/station 13 server suite</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Server Architecture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#arch_intro">Introduction</a></li>
<li class="level1"><a href="#arch_hwatchdog">Host Watchdog</a></li>
<li class="level1"><a href="#arch_main">Main Server</a><ul><li class="level2"><a href="#arch_setup">Server Initialization</a><ul><li class="level3"><a href="#arch_instinit">Instance Manager Initialization</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#arch_db">Database and Context</a></li>
<li class="level1"><a href="#arch_security">Security</a></li>
<li class="level1"><a href="#arch_controllers">Controllers</a></li>
<li class="level1"><a href="#arch_jobs">Jobs</a></li>
<li class="level1"><a href="#arch_instance">Instances</a><ul><li class="level2"><a href="#arch_ifactory">Instance Factory</a></li>
</ul>
</li>
<li class="level1"><a href="#arch_watchdog">Watchdog</a><ul><li class="level2"><a href="#Communication">Communication</a></li>
</ul>
</li>
<li class="level1"><a href="#arch_update">Host Update Process</a></li>
</ul>
</div>
<div class="textblock"><div class="image">
<img src="ArchitectureOverview.png" alt="ArchitectureOverview.png"/>
<div class="caption">
Architecture Overview</div></div>
 <h1><a class="anchor" id="arch_intro"></a>
Introduction</h1>
<p>This is meant to be a brief overview of the TGS4 architecture to give new coders direction on where to code and the curious some insight to their questions. Given that this document is seperate from the authorative code it may fall out of date. For clairity, please contact project maintainers.</p>
<h1><a class="anchor" id="arch_hwatchdog"></a>
Host Watchdog</h1>
<p>The host watchdog process monitors the actual server application. It exists mainly to facilitate the live update system built into it and also serves as a restart mechanism if requested. This component is generally not present in active development scenarios due to debugging overhead.</p>
<p>This consists of two parts a runner and the watchdog library. The library is the <a class="el" href="namespace_tgstation_1_1_server_1_1_host_1_1_watchdog.html">Tgstation.Server.Host.Watchdog</a> project and the runners are the <a class="el" href="namespace_tgstation_1_1_server_1_1_host_1_1_console.html">Tgstation.Server.Host.Console</a> .NET Core project and the <a class="el" href="namespace_tgstation_1_1_server_1_1_host_1_1_service.html">Tgstation.Server.Host.Service</a> .NET Framework Windows service project</p>
<h1><a class="anchor" id="arch_main"></a>
Main Server</h1>
<p>This is a second process spawned by the Host Watchdog which facilitates the vast majority of the code. This is the <a class="el" href="namespace_tgstation_1_1_server_1_1_host.html">Tgstation.Server.Host</a> project which is fundamentally an ASP.NET Core MVC web application.</p>
<h2><a class="anchor" id="arch_setup"></a>
Server Initialization</h2>
<p>The server's entrypoint is in the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_program.html">Tgstation.Server.Host.Program</a> class. This class mainly determines if the Host watchdog is present and creates and runs the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_server.html">Tgstation.Server.Host.Server</a> class. That class then builds an ASP.NET Core web host using the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html">Tgstation.Server.Host.Core.Application</a> class.</p>
<p>The <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html">Tgstation.Server.Host.Core.Application</a> class has two methods called by the framework. First the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html#aceaab5ce98c719a556d7e9af25d0da81">Tgstation.Server.Host.Core.Application.ConfigureServices</a> method sets up dependency injection of interfaces for Controllers, the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_models_1_1_database_context.html">Tgstation.Server.Host.Models.DatabaseContext</a>, and the component factories of the server. The framework handles constructing these things once the application starts. Configuration is loaded from the appropriate appSettings.json into the <a class="el" href="namespace_tgstation_1_1_server_1_1_host_1_1_configuration.html">Tgstation.Server.Host.Configuration</a> classes for injection as well. Then <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html#a1f066856d593589de85362560be60853">Tgstation.Server.Host.Core.Application.Configure</a> method is run which sets up the web request pipeline which currently has the following stack of handlers:</p>
<ul>
<li>Catch any exceptions and respond with 500 and detailed HTML error page</li>
<li>Respond with 503 if the application is still starting or shutting down</li>
<li>Authenticate the JWT in Authentication header if present and run <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_controllers_1_1_api_controller.html">Tgstation.Server.Host.Controllers.ApiController</a> on success</li>
<li>Catch database exceptions and convert to 409 responses with the exception's <a class="el" href="class_tgstation_1_1_server_1_1_api_1_1_models_1_1_error_message.html">Tgstation.Server.Api.Models.ErrorMessage</a></li>
<li>Check <a class="el" href="namespace_tgstation_1_1_server_1_1_host_1_1_controllers.html">Tgstation.Server.Host.Controllers</a> for correct controller and run the action and use it's response.<ul>
<li>If not properly authenticated beforehand and action has a <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_controllers_1_1_tgs_authorize_attribute.html">Tgstation.Server.Host.Controllers.TgsAuthorizeAttribute</a> return 401</li>
<li>If not properly authorized beforehand according to the parameters of the action's <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_controllers_1_1_tgs_authorize_attribute.html">Tgstation.Server.Host.Controllers.TgsAuthorizeAttribute</a> (if present) return 403</li>
<li>If requested action does not exist return 404</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="arch_instinit"></a>
Instance Manager Initialization</h3>
<p>Once the web host starts, the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_components_1_1_instance_manager.html#aa2bcc92fca46ad404800304ce4bdd781">Tgstation.Server.Host.Components.InstanceManager.StartAsync</a> function is called (due to being registered as a <a class="el" href="class_i_hosted_service.html">IHostedService</a> in <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html">Tgstation.Server.Host.Core.Application</a>) this is the only StartAsync implementation that should be called by the framework, others should be called from this to maintain a cohesive initialization order.</p>
<p>The first thing this function does is call <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_models_1_1_database_context.html#aac1c768a59e2efecac4dac179533ca4c">Tgstation.Server.Host.Models.DatabaseContext.Initialize</a> which ensures the database is migrated, seeded, and ready to go. Then the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_job_manager.html">Tgstation.Server.Host.Core.JobManager</a> is started, which cleans up any jobs that are considered "still running" in the database. Finally all instances configured to be online are created in parallel (See <a class="el" href="architecture.html#arch_instance">Instances</a> for onlining process) and the <a class="el" href="class_tgstation_1_1_server_1_1_host_1_1_core_1_1_application.html">Tgstation.Server.Host.Core.Application</a> is signalled to stop blocking requests with 503 responses before they are processed.</p>
<h1><a class="anchor" id="arch_db"></a>
Database and Context</h1>
<h1><a class="anchor" id="arch_security"></a>
Security</h1>
<h1><a class="anchor" id="arch_controllers"></a>
Controllers</h1>
<h1><a class="anchor" id="arch_jobs"></a>
Jobs</h1>
<h1><a class="anchor" id="arch_instance"></a>
Instances</h1>
<h2><a class="anchor" id="arch_ifactory"></a>
Instance Factory</h2>
<h1><a class="anchor" id="arch_watchdog"></a>
Watchdog</h1>
<h2><a class="anchor" id="Communication"></a>
Communication</h2>
<h1><a class="anchor" id="arch_update"></a>
Host Update Process</h1>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
